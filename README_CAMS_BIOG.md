# CAMS Anthropogenic Emissions Regridding Tool

## 1. Description
This tool regrids CAMS global biogenic emissions data to the MPAS grid using ESMF/ESMPy. It automates the process for multiple species and years, renames output variables and dimensions for MPAS compatibility, and allows easy configuration via a YAML file. Output files are post-processed for MPAS requirements, including correct variable naming, dimension renaming, and time formatting.

## 2. Python Environment Setup
**NOTE:** If you already have the required Python libraries installed, you can skip this section and go to Section 3. The environment for processing biogenic emissions is identicl to that for CAMS anthropogneic emissions and uses the same environment as well. 
You need Python 3.8+ and the following libraries:
- numpy
- xarray
- esmpy
- netCDF4
- pyyaml

To set up a dedicated environment called `regrid_CAMS_anth` using conda:
```bash
conda create -n regrid_CAMS_anth python=3.10
conda activate regrid_CAMS_anth
conda install numpy xarray netCDF4 pyyaml
pip install esmpy
```
If you use pip only:
```bash
python3 -m venv regrid_CAMS_anth
source regrid_CAMS_anth/bin/activate
pip install numpy xarray netCDF4 pyyaml esmpy
```

## 3. Python Script Overview
- `Regrid_cams_biog_emis_to_MPAS.py`: Main workflow script. Reads configuration, performs regridding, post-processes output files.
- `Regridding_ESMF.py`: Contains core logic for regridding and NetCDF file creation using ESMF/ESMPy.
- `Calc_Emis.py`: Utility for emission calculations (used internally).
- `postprocess_cams_anth_to_mpas.py`: Handles post-processing for MPAS compatibility (variable renaming, dimension renaming, xtime formatting).
- `config_cams_biog_regrid.yaml`: User-editable configuration file for all workflow settings.

## 4. Configuration File: `config_cams_biog_regrid.yaml`
This YAML file defines all user-editable settings. Below is a description of the contents:
- `CAMS_GLOB_BIOG_dir`: Directory containing original CAMS emissions data
- `CAMS_grid_file`: Grid info file, generated by `Regrid_cams_anth_emis_to_MPAS.py`
- `SERR_scrip_file`: SCRIP file for the destination grid, generated using [mpas2esmf tool](https://github.com/MPAS-Dev/MPAS-Tools/tree/master/mesh_tools/mpas2esmf)
- `Regridding_weights_file`: Name of the weights file. If it does not exist, it will be created automatically; otherwise, the code will use the existing file.
- `dst_file_format`: Output file name format
- `inp_file_format`: Input file name format
- `sectors`: List of sectors to process. Leave empty (`[]`) to process all sectors in CAMS emissions, or specify desired sectors.

Example YAML file:
```yaml
year: 2024
species:
  - alpha-pinene
  - beta-pinene
  - carbon-monoxide
  - isoprene
  - other-monoterpenes
CAMS_GLOB_BIOG_dir: '/glade/derecho/scratch/lacey/CAMS/'
CAMS_grid_file: '/glade/work/lacey/PACE-MPAS-A/PythonTest/Gridinfo_CAMS-GLOB-BIOG_c20260116.nc'
SERR_scrip_file: '/glade/campaign/ncar/nmmm0072/lacey/UPTEMPO/UPTEMPO_IndiaVR/GRID/x6.999426.India.grid.scrip.nc'
Regridding_weights_file: '/glade/work/lacey/PACE-MPAS-A/PythonTest/ESMF_Weight_CAMSv3.1_grid_to_MPAS.x6.999426.India_c20260116.nc'
dst_file_format: '/glade/derecho/scratch/lacey/MPAS_DEVEL/input/x6.999426.India/EMIS/CAMS-GLOB-BIOG_{year}_MPAS.x6.999426.India.grid.SPC.nc'
inp_file_format: '/glade/derecho/scratch/lacey/CAMS/CAMS-GLOB-BIO_v3.1_SPC_2019.nc'
sectors: []
```
- Edit paths and values as needed for your system and desired year/species.
- Save as `config_cams_anth_regrid.yaml` in the same directory as the main script. An example file is included in the directory for reference.

## 5. How to Run
Activate your environment and run:
```bash
python Regrid_cams_biog_emis_to_MPAS.py config_cams_biog_regrid.yaml
```

## 6. Output
- Output files will be created in the location specified by `dst_file_format` in the YAML file.
- Each file will have the correct year, species, and MPAS-GOCART-2G compatible variable/dimension names.
- For isoprene, output variables are named `iso_anth_{src_var}`; for monoterpenes, `mnt_anth_{src_var}`; for other species, `{species}_anth_{src_var}`.
- All output files use dimensions `Time`, `nCells`, and `StrLen=64`. **StrLen=64 is required by MPAS architecture. Do not change it. The model will fail with a smaller value.**
- The `xtime` variable is written as a character array with no trailing spaces, matching MPAS requirements.
- Global attributes include `authors` and `time_created`.
- The post-processing step overwrites the original output file with the MPAS-compatible version.

## 7. Support
For questions or issues, contact:
- Forrest Lacey (lacey@ucar.edu)
- Rajesh Kumar (rkumar@ucar.edu)
